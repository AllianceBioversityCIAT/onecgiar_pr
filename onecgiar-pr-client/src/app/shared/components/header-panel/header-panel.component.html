@let unreadNotifications = this.resultsNotificationsSE.updatesPopUpData;

@if (!this.dataControlSE.show_qa_full_screen) {
  <div class="header_panel_container">
    <a
      class="logo_container"
      routerLink="/"
      aria-label="Go to home"
      #homeLink
      (keydown.space)="$event.preventDefault(); homeLink.click()"
      (keydown.enter)="homeLink.click()">
      <img class="cgiar_logo" src="/assets/PR_logo.svg" alt="Reporting Tool Logo" />

      <div class="logo_content">
        <p class="logo_platform_name">{{ this.internationalizationData.global.platformName }}</p>
        <p class="logo_platform_name_secondary">
          {{ this.api.dataControlSE?.reportingCurrentPhase?.portfolioAcronym }} - {{ this.api.dataControlSE?.reportingCurrentPhase?.phaseName }}
        </p>
      </div>
    </a>

    <app-navigation-bar></app-navigation-bar>

    <div class="information">
      <a
        #whatsNewLink
        (keydown.space)="$event.preventDefault(); whatsNewLink.click()"
        routerLink="/whats-new"
        pTooltip="What's new?"
        tooltipPosition="bottom"
        routerLinkActive="section_active"
        style="border-bottom: 4px solid transparent; border-top: 4px solid transparent">
        <i class="material-icons-round info_icon" routerLinkActive="info_icon_active">rocket_launch</i>
      </a>

      <button
        type="button"
        [satPopoverAnchor]="notificationsPopover"
        (click)="notificationsPopover.toggle()"
        aria-label="Notifications"
        aria-haspopup="true"
        [attr.aria-expanded]="notificationsPopover.isOpen()"
        aria-controls="notifications-popover"
        [ngStyle]="{ 'margin-top': unreadNotifications.length > 0 && '-6px' }"
        style="border-bottom: 4px solid transparent; border-top: 4px solid transparent">
        @if (unreadNotifications.length === 0) {
          <i class="material-icons-round info_icon" [ngClass]="{ info_icon_active: notificationsPopover.isOpen() }" aria-hidden="true"
            >notifications</i
          >
        } @else {
          <p-overlayBadge [value]="notificationBadgeLength()" severity="danger" [style]="{ 'outline-style': 'none' }">
            <i class="material-icons-round animate_bell info_icon" [ngClass]="{ info_icon_active: notificationsPopover.isOpen() }" aria-hidden="true">
              notifications
            </i>
          </p-overlayBadge>
        }
      </button>

      <button
        type="button"
        style="border-bottom: 4px solid transparent; border-top: 4px solid transparent"
        aria-label="User menu"
        [satPopoverAnchor]="userInfoPopover"
        (click)="userInfoPopover.toggle()">
        <p-avatar [label]="getUserInitials()" shape="circle" [style]="{ width: '32px', height: '32px', cursor: 'pointer' }" />
      </button>
    </div>
  </div>
}

<sat-popover
  #userInfoPopover
  id="user-info-popover"
  hasBackdrop
  horizontalAlign="center"
  verticalAlign="below"
  scrollStrategy="close"
  [autoFocus]="false">
  <div class="overlay_panel" [style]="{ width: '250px' }">
    <div class="overlay_panel_header">
      <div class="overlay_panel_header_userInfo">
        <p-avatar [label]="getUserInitials()" shape="circle" [style]="{ minWidth: '36px', maxWidth: '36px', minHeight: '36px', maxHeight: '36px' }" />

        <div class="overlay_panel_header_userInfo_content">
          <p class="overlay_panel_header_userInfo_content_name">{{ this.api.authSE.localStorageUser?.user_name }}</p>
          <p class="overlay_panel_header_userInfo_content_email">{{ this.api.authSE.localStorageUser?.email }}</p>
        </div>
      </div>
    </div>

    <div class="overlay_panel_userInfo_content">
      @if (this.getInitiativeSeparatedByPortfolio().length > 0) {
        <div class="overlay_panel_userInfo_content_item">
          <p class="overlay_panel_userInfo_content_item_title">My Science Programs/Accelerators</p>

          @for (item of this.getInitiativeSeparatedByPortfolio(); track $index) {
            <p class="overlay_panel_userInfo_content_item_desc">{{ item.official_code }} - {{ item.role }}</p>
          }
        </div>
      }

      @if (this.api.rolesSE.isAdmin) {
        <a
          class="overlay_panel_admin_module"
          routerLink="/admin-module/completeness-status"
          role="menuitem"
          #adminLink
          (keydown.space)="$event.preventDefault(); adminLink.click()"
          (keydown.enter)="adminLink.click()"
          (click)="userInfoPopover.toggle()">
          <i class="pi pi-wrench admin_module_icon" aria-hidden="true"></i>
          <p class="overlay_panel_admin_module_title">Admin module</p>
        </a>
      }
    </div>

    <div class="overlay_panel_separator"></div>

    <button
      type="button"
      class="overlay_panel_footer footer_userInfo"
      (click)="userInfoPopover.toggle(); this.api.authSE.logout()"
      aria-label="Log out">
      <i class="material-icons-round logout_icon" aria-hidden="true">logout</i>
      <p class="logout_button">Log out</p>
    </button>
  </div>
</sat-popover>

<sat-popover
  #notificationsPopover
  id="notifications-popover"
  hasBackdrop
  horizontalAlign="center"
  verticalAlign="below"
  scrollStrategy="close"
  [autoFocus]="false">
  <div class="overlay_panel" [style]="{ width: '340px' }">
    <div class="overlay_panel_header">
      <h1 class="overlay_panel_header_title">Notifications</h1>
    </div>

    <div class="overlay_panel_separator" [ngStyle]="{ 'margin-bottom': unreadNotifications.length > 0 && '0' }"></div>

    @if (unreadNotifications.length === 0) {
      <p class="no_notifications">
        You have not received any new notifications. Go to the notifications section to see all of your latest notifications.
      </p>
    } @else {
      <div class="notifications_list">
        @for (notification of unreadNotifications; track $index) {
          <app-pop-up-notification-item [notification]="notification" (click)="notificationsPopover.toggle()"></app-pop-up-notification-item>
        }
      </div>
    }

    <div class="overlay_panel_separator" *ngIf="unreadNotifications.length === 0"></div>

    <div class="overlay_panel_footer" [ngStyle]="{ 'padding-top': unreadNotifications.length > 0 && '15px' }">
      <button
        type="button"
        class="see_all_notifications"
        (click)="goToNotifications(); notificationsPopover.toggle()"
        aria-label="See all the notifications">
        See all the notifications
      </button>
    </div>
  </div>
</sat-popover>

<app-tawk
  *ngIf="this.api.authSE.localStorageUser?.user_name && this.api.authSE.localStorageUser?.email && !inLocal"
  [user]="{ username: this.api.authSE.localStorageUser.user_name, email: this.api.authSE.localStorageUser.email }">
</app-tawk>
