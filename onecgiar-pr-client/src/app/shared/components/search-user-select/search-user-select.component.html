<div class="select-container">
  <label class="select-label" for="user-select-dropdown"> Select a user: <span class="required">*</span> </label>

  <p-dropdown
    id="user-select-dropdown"
    [options]="options()"
    [(ngModel)]="selectedUser"
    placeholder="Select a user"
    optionLabel="formattedName"
    [filter]="true"
    [loading]="isLoading()"
    (onShow)="onDropdownShow()"
    (onHide)="onDropdownHide()"
    (onChange)="onUserChange($event.value)"
    [style]="{ width: '100%' }">
    <!-- Custom Filter Template -->
    <ng-template pTemplate="filter" let-options="options">
      <div class="custom-filter-container" (click)="$event.stopPropagation()">
        <div class="p-inputgroup">
          <span class="p-inputgroup-addon">
            <i class="pi pi-search"></i>
          </span>
          <input
            type="text"
            pInputText
            placeholder="Search users... (min 3 characters)"
            [(ngModel)]="filterValue"
            (keyup)="customFilterFunction($event, options)" />
        </div>
        @if (filterValue) {
          <button pButton icon="pi pi-times" (click)="resetFilter(options)" severity="secondary" [text]="true" size="small"></button>
        }
      </div>
    </ng-template>

    <!-- Item Template -->
    <ng-template let-option pTemplate="item">
      <div class="user-option">
        <div class="user-display-name">{{ option.sn }}, {{ option.givenName }} ({{ option.mail }})</div>
      </div>
    </ng-template>

    <!-- Empty Template -->
    <ng-template pTemplate="empty">
      <div class="empty-message">
        @if (isLoading()) {
          <div>
            <i class="pi pi-spin pi-spinner"></i>
            <span>Searching users...</span>
          </div>
        } @else {
          @if (showMinCharsMessage()) {
            <div>
              <i class="pi pi-info-circle"></i>
              <span>Please enter at least 3 characters to search</span>
            </div>
          } @else {
            <div>
              <i class="pi pi-exclamation-triangle"></i>
              <span>No users found. Try a different search term.</span>
            </div>
          }
        }
      </div>
    </ng-template>
  </p-dropdown>
</div>

<!-- Expandable space INSTANT (no animation) -->
@if (isDropdownOpen()) {
  <div class="expandable-space expanded"></div>
}
