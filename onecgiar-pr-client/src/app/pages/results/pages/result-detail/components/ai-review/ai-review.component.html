<p-dialog
  header="AI Review"
  [modal]="true"
  [(visible)]="aiReviewSE.showAiReview"
  [style]="{ width: '90vw', maxWidth: '1200px' }"
  [dismissableMask]="true"
  [draggable]="false"
  [resizable]="false">
  <div class="ai-review-container">
    <div class="ai-review-header">
      <img src="assets/icons/stars.png" alt="" srcset="" /> The AI analyzed your information and identified the following:
    </div>

    @for (field of aiReviewSE.currnetFieldsList(); track $index) {
      <!-- Title Section -->
      <div class="field-section">
        <div class="field-header">
          <h3 class="field-title">{{ field.field_name_label }}</h3>
          @if (field.original_text == field.proposed_text) {
            <span class="improvement-badge updated-badge"> <img src="assets/icons/stars.png" alt="" srcset="" /> Updated</span>
          } @else {
            <span class="improvement-badge needs-improvement-badge"> <i class="pi pi-exclamation-triangle"></i> Needs improvement</span>
          }
        </div>

        <div class="proposal-section">
          <div class="proposal-label"><i class="pi pi-lightbulb"></i> AI proposal</div>
          <div class="proposal-content">
            {{ field.proposed_text }}
          </div>

          @if (field.original_text == field.proposed_text) {
            <div class="applied-badge"><i class="pi pi-check-circle"></i> Applied</div>
          } @else {
            <div class="apply-proposal-button" (click)="moveTextToInput(field)">Apply proposal</div>
          }
        </div>

        <div class="line-divider"></div>

        <div class="current-version">
          <label class="version-label">Result version</label>
          @if ($index === 1) {
            <app-pr-textarea [readOnly]="false" [(ngModel)]="field.original_text" placeholder=""> </app-pr-textarea>
          } @else {
            <app-pr-input type="text" [readOnly]="false" [(ngModel)]="field.original_text" placeholder=""> </app-pr-input>
          }
        </div>

        <app-pr-button
          [ngClass]="{ globalDisabled: !field.canSave }"
          text="Save changes"
          icon="save"
          [showBackground]="true"
          class="save-button-custom"
          onkeypress="aiReviewSE.onApplyProposal(field, $index)"
          (click)="aiReviewSE.onApplyProposal(field, $index)">
        </app-pr-button>
      </div>
    }

    <!-- Impact Areas Section -->
    <div class="impact-areas-section">
      <h2 class="section-title">IMPACT AREAS</h2>

      <div class="impact-areas-grid">
        @for (dacScore of aiReviewSE.dacScores(); track dacScore.field_name) {
          <div class="field-section" [class.ai-validated]="dacScore.is_validated">
          <div class="field-header">
            <h3 class="field-title">{{ dacScore.display_title || dacScore.field_name }}</h3>
            @if (dacScore.is_validated) {
              <span class="improvement-badge updated-badge"> <i class="pi pi-check-circle"></i> AI Validated</span>
            } @else {
              <span class="improvement-badge needs-improvement-badge"> <i class="pi pi-exclamation-triangle"></i> Needs improvement</span>
            }
          </div>

          @if (!dacScore.is_validated) {
            <div class="proposal-section">
              <div class="proposal-label"><i class="pi pi-lightbulb"></i> AI review</div>
              <div class="proposal-content">
                {{ dacScore.ai_recommendation || 'No AI recommendation available' }}
              </div>
            </div>
          }

          <div class="line-divider"></div>

          <label class="version-label">Result version</label>
          <div class="current-version">
            <div class="radio-button-group">
              @for (option of scoreSE.genderTagScoreList; track option.id) {
                <div class="radio-button-item" (click)="onResultVersionChange(dacScore, option.id)">
                  <div class="radio-circle" [class.selected]="dacScore.tag_id === option.id">
                    @if (dacScore.tag_id === option.id) {
                      <div class="radio-dot"></div>
                    }
                  </div>
                  <label class="radio-label">{{ option.full_name }}</label>
                </div>
              }
            </div>
          </div>

          @if (dacScore.tag_id === '3') {
            <div class="component-section">
              <label class="version-label">Component</label>
              <div class="radio-button-group">
                @for (component of getComponentListByFieldName(dacScore.field_name); track component.id) {
                  <div class="radio-button-item" (click)="onComponentChange(dacScore, component.id)">
                    <div class="radio-circle" [class.selected]="dacScore.impact_area_id === component.id">
                      @if (dacScore.impact_area_id === component.id) {
                        <div class="radio-dot"></div>
                      }
                    </div>
                    <label class="radio-label">{{ component.name }}</label>
                  </div>
                }
              </div>
            </div>
          }

          <app-pr-button
            [ngClass]="{ globalDisabled: !dacScore.canSave }"
            text="Save changes"
            icon="save"
            [showBackground]="true"
            class="save-button-custom"
            (click)="onSaveDacScore(dacScore)">
          </app-pr-button>
          </div>
        }
      </div>
    </div>
  </div>
</p-dialog>
