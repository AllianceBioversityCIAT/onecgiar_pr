<p-dialog
  appendTo="body"
  header="Title"
  [(visible)]="this.api.dataControlSE.showShareRequest"
  (onHide)="cleanObject()"
  [draggable]="false"
  [modal]="true"
  [closeOnEscape]="true"
  [showHeader]="false"
  [dismissableMask]="true"
  [style]="{ padding: '0px' }">
  <div class="modal_title">Request to be added as contributor of a result</div>

  <div
    *ngIf="showForm"
    class="modal_container partners-request-container"
    [ngClass]="{
      small_height: this.api.dataControlSE?.currentResult?.result_level_id !== 4 && this.api.dataControlSE?.currentResult?.result_level_id !== 3
    }">
    <div class="information">
      {{ this.api?.dataControlSE?.currentResult?.result_type }} - <strong>{{ this.api?.dataControlSE?.currentResult?.title }}</strong> has already
      been recorded for <strong> {{ this.api?.dataControlSE?.currentResult?.submitter }}. </strong>
    </div>

    <app-pr-field-header label="Select entity"></app-pr-field-header>
    <p-select
      [options]="!this.api.rolesSE.isAdmin ? this.api.dataControlSE.myInitiativesList : this.allInitiatives"
      optionLabel="full_name"
      optionValue="initiative_id"
      placeholder="Select entity"
      [(ngModel)]="this.shareRequestModalSE.shareRequestBody.initiative_id"
      (ngModelChange)="modelChange()"
      [style]="{ width: '100%' }"
      [filter]="true"
      [disabled]="!this.api.rolesSE.isAdmin && this.api.dataControlSE.inNotifications"
      [optionDisabled]="">
      <ng-template #selectedItem let-selectedOption>
        <div [innerHtml]="selectedOption.full_name"></div>
      </ng-template>
      <ng-template let-item #item>
        <div [innerHtml]="item.full_name"></div>
      </ng-template>
    </p-select>

    @if (shouldShowTocInitiativeOut && !fieldsManagerSE.isP25()) {
      <app-toc-initiative-out
        [initiative]="shareRequestModalSE.shareRequestBody"
        [isNotifications]="true"
        [editable]="
          !this.api.rolesSE.platformIsClosed &&
          (this.rolesSE.validateInitiative(shareRequestModalSE.shareRequestBody?.initiative_id) ||
            this.rolesSE.isAdmin ||
            this.api.dataControlSE.inNotifications)
        "
        [resultLevelId]="this.api.dataControlSE?.currentResult?.result_level_id === 4 && !this.api.resultsSE.ipsrDataControlSE.inIpsr ? 1 : 2">
      </app-toc-initiative-out>
    }

    @if (fieldsManagerSE.isP25()) {
      <app-pr-yes-or-not
        label="Does this result align with the Program's planned TOC indicators?"
        [editable]="true"
        [required]="true"
        [(ngModel)]="shareRequestModalSE.shareRequestBody.planned_result"
        (selectOptionEvent)="onPlannedResultChange(shareRequestModalSE.shareRequestBody)"
        [hideOptions]="!shareRequestModalSE.shareRequestBody.result_toc_results?.length">
      </app-pr-yes-or-not>

      @if (shareRequestModalSE.shareRequestBody.planned_result !== null) {
        @if (this.tocConsumed) {
          <app-cp-multiple-wps
            [editable]="true"
            [initiative]="shareRequestModalSE.shareRequestBody"
            [initiativeId]="shareRequestModalSE.shareRequestBody?.initiative_id"
            [resultLevelId]="this.api.dataControlSE.currentResultSignal()?.result_level_id"
            [isNotifications]="true"
            [isIpsr]="false"
            [isUnplanned]="!shareRequestModalSE.shareRequestBody.planned_result"
            [showMultipleWPsContent]="this.tocConsumed"
            [forceP25]="true"></app-cp-multiple-wps>
        }
      }
    }
  </div>

  <div class="buttons">
    @if (!this.api.dataControlSE.inNotifications) {
      <app-pr-button
        padding="medium"
        text="Cancel"
        icon="cancel_schedule_send"
        colorType="secondary"
        (click)="this.api.dataControlSE.showShareRequest = false">
      </app-pr-button>

      <app-pr-button
        [text]="this.requesting ? 'Saving' : 'Send Request'"
        [rotating]="this.requesting"
        [ngClass]="{ globalDisabled: validateAcceptOrReject() }"
        [icon]="this.requesting ? 'loop' : 'send'"
        padding="medium"
        (click)="onRequest()">
      </app-pr-button>
    }

    @if (this.api.dataControlSE.inNotifications) {
      <app-pr-button
        [text]="this.requesting ? 'Saving' : 'Accept'"
        [rotating]="this.requesting"
        [ngClass]="{ globalDisabled: this.api.dataControlSE?.currentResult?.result_level_id === 4 && validateAcceptOrReject() }"
        [icon]="this.requesting ? 'loop' : 'send'"
        padding="medium"
        (click)="acceptOrReject()">
      </app-pr-button>
    }
  </div>
</p-dialog>
