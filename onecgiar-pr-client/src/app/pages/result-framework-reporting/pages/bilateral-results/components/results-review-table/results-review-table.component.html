<p-table
  styleClass="p-datatable-gridlines p-datatable-sm bilateral-results-table"
  [value]="filteredTableData()"
  sortField="project_name"
  [sortOrder]="1"
  responsiveLayout="scroll"
  dataKey="project_name"
  sortMode="single"
  rowGroupMode="subheader"
  groupRowsBy="project_name"
  [expandedRowKeys]="expandedRowKeys()">

  <!-- Header -->
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 5%">Code</th>
      <th style="width: 15%">Title</th>
      <th style="width: 10%">Indicator category</th>
      <th style="width: 8%">Status</th>
      <th style="width: 18%">TOC result</th>
      <th style="width: 15%">Indicator</th>
      <th style="width: 10%">Submission date</th>
      <th style="width: 19%; text-align: center">Actions</th>
    </tr>
  </ng-template>

  <!-- Group Header -->
  <ng-template pTemplate="groupheader" let-item let-expanded="expanded">
    <tr>
      <td colspan="8" class="group-header-cell">
        <div class="group-header-content" pRipple [pRowToggler]="item">
          <button
            type="button"
            pButton
            class="p-button-text p-button-rounded group-toggle-button"
            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'">
          </button>
          <span class="group-title">{{ item.project_name }}</span>
        </div>
      </td>
    </tr>
  </ng-template>

  <!-- Expanded Rows -->
  <ng-template #expandedrow let-group>
    @for (result of group.results; track result.id) {
      <tr>
        <td class="code-cell">{{ result.result_code }}</td>
        <td class="title-cell">{{ result.result_title }}</td>
        <td class="category-cell">{{ result.indicator_category }}</td>
        <td class="status-cell">
          <span
            class="status-badge"
            [ngClass]="{
              'approved': result.status_name === 'Approved',
              'rejected': result.status_name === 'Rejected',
              'pending': result.status_name !== 'Approved' && result.status_name !== 'Rejected'
            }">
            {{ result.status_name }}
          </span>
        </td>
        <td class="toc-cell">{{ result.toc_title }}</td>
        <td class="indicator-cell">{{ result.indicator }}</td>
        <td class="date-cell">{{ result.submission_date | date: 'dd/MM/yyyy' }}</td>
        <td class="actions-cell">
          <button
            pButton
            type="button"
            variant="outlined"
            class="review-result-button"
            (click)="reviewResult(result)"
            pTooltip="Review result"
            tooltipPosition="top">
            <i class="material-icons-outlined">edit</i>
            <span>Review result</span>
          </button>
        </td>
      </tr>
    }
  </ng-template>

  <!-- Empty Message -->
  <ng-template pTemplate="emptymessage">
    <tr style="height: 200px">
      <td colspan="8" class="empty-message">
        No results found.
      </td>
    </tr>
  </ng-template>
</p-table>

@if (showReviewDrawer()) {
  <app-result-review-drawer
    [(visible)]="showReviewDrawer"
    [(resultToReview)]="currentResultToReview"
    (decisionMade)="onDecisionMade()">
  </app-result-review-drawer>
}
