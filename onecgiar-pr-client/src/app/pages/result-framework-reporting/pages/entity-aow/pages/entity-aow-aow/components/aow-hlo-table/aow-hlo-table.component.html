<p-table
  id="tocResultsByAowIdTable"
  styleClass="p-datatable-gridlines p-datatable-sm"
  [value]="entityAowService.tocResultsByAowId()"
  [loading]="entityAowService.isLoadingTocResultsByAowId()"
  sortField="result_title"
  [sortOrder]="1"
  responsiveLayout="scroll"
  dataKey="result_title"
  sortMode="single"
  rowGroupMode="subheader"
  groupRowsBy="result_title">
  <ng-template pTemplate="header">
    <tr>
      @for (column of columnOrder(); track column.attr) {
        <th [pSortableColumn]="column.attr" [id]="column.attr">
          @if (!column.hideSortIcon) {
            <p-sortIcon [field]="column.attr"></p-sortIcon>
          }
          {{ column.title }}
        </th>
      }
      <th id="actions">Actions</th>
    </tr>
  </ng-template>

  <ng-template #groupheader let-item let-rowIndex="rowIndex" let-expanded="expanded">
    <tr>
      <td colspan="8" style="background: var(--pr-color-primary-25); border-bottom: 1px solid var(--pr-color-secondary-50)">
        <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; padding-right: 20px">
          <div style="display: flex; justify-content: flex-start; align-items: center; gap: 0.5rem; cursor: pointer" pRipple [pRowToggler]="item">
            <button
              type="button"
              pButton
              class="p-button-text p-button-rounded"
              style="border: none; box-shadow: none !important"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>

            <span style="font-weight: bold">{{ item.result_title }}</span>
          </div>

          <div style="display: flex; justify-content: flex-start; align-items: center; gap: 5px; cursor: not-allowed">
            <span class="material-icons-round text-primary-300" style="font-size: 16px"> mail </span>

            <p class="pr-body-3 text-primary-300 font-weight-400">View associated bilateral projects</p>
          </div>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template #expandedrow let-item>
    @for (result of item.indicators; track $index) {
      <tr>
        <td class="text-secondary-300" style="min-width: 150px !important">{{ result.indicator_description }}</td>
        <td>
          <div class="tab-content_chip">
            {{ result.type_value }}
          </div>
        </td>
        <td style="text-align: center">{{ result.target_value_sum }}</td>
        <td style="text-align: center">{{ result.actual_achieved_value_sum }}</td>
        <td>
          <div class="tab-content_progress">
            <p-progressbar [value]="getProgress(result.progress_percentage)" [showValue]="false" [style]="{ width: '65px', height: '8px' }" />
            <p class="tab-content_progress_value">{{ result.progress_percentage }}</p>
          </div>
        </td>
        <td>
          <div
            class="tab-content_chip in-progress"
            style="width: max-content"
            [ngClass]="{ achieved: getProgress(result.progress_percentage) >= 90 }">
            In progress
          </div>
        </td>
        <td>
          <div class="tab-content_actions">
            <button
              pButton
              label="Report result"
              type="button"
              class="pr-body-3 tab-content_actions_button"
              (click)="openReportResultModal(item, result.id)"></button>
            <button pButton label="View results" type="button" class="p-button-outlined pr-body-3 tab-content_actions_button"></button>
            <button pButton label="Progress by program" type="button" class="p-button-outlined pr-body-3 tab-content_actions_button"></button>
          </div>
        </td>
      </tr>
    }
  </ng-template>

  <ng-template #emptymessage>
    <tr style="height: 200px">
      <td colspan="8" class="tab-content_empty">There are no High-Level Outputs Indicators found.</td>
    </tr>
  </ng-template>
</p-table>

<p-dialog
  #reportResultDialog
  [modal]="true"
  [visible]="entityAowService.showReportResultModal()"
  styleClass="report-result-dialog"
  [showHeader]="false"
  (onHide)="entityAowService.currentResultToReport.set({})">
  <div class="report-result-header">
    <span class="font-bold whitespace-nowrap">Report result</span>
    <i class="material-icons-round" style="font-size: 20px; cursor: pointer" (click)="entityAowService.showReportResultModal.set(false)">close</i>
  </div>

  <div class="report-result-content">
    <div class="report-result-content_left">
      <div class="report-result-content_left_header">
        <p class="report-result-content_left_header_subtitle">
          {{ entityAowService.entityId() }} - {{ entityAowService.entityDetails().name }} / {{ entityAowService.currentAowSelected()?.code }} -
          {{ entityAowService.currentAowSelected()?.name }}
        </p>
        <p class="report-result-content_left_header_title">{{ entityAowService.currentResultToReport()?.result_title }}</p>
        <p class="report-result-content_left_header_desc">{{ entityAowService.currentResultToReport()?.indicators?.[0]?.indicator_description }}</p>
      </div>
      <div class="report-result-content_left_content">
        <div class="report-result-content_left_content_indicator">
          <span class="report-result-content_left_content_label">Indicator category: </span>
          <span class="report-result-content_left_content_value">{{ entityAowService.currentResultToReport()?.indicators?.[0]?.type_value }}</span>
        </div>

        @if (entityAowService.currentResultIsKnowledgeProduct()) {
          <div class="mqap_sync_title">
            <app-pr-input [isStatic]="true" placeholder="Handle..." label="CGSpace link" type="text" labelDescInlineStyles="margin-top: 0 !important">
            </app-pr-input>

            <div (click)="GET_mqapValidation()" class="sync_button">
              <app-pr-button padding="medium" padding="small" [verticalMargin]="0" text="Sync" icon="sync" [rotating]="true"></app-pr-button>
            </div>
          </div>
        }

        <app-pr-input
          [isStatic]="true"
          [placeholder]="entityAowService.currentResultIsKnowledgeProduct() ? 'Knowledge product title...' : 'Input title...'"
          label="Title"
          type="text"
          [description]="entityAowService.currentResultIsKnowledgeProduct() ? 'Title retrieved from CGSpace' : ''"
          labelDescInlineStyles="margin-top: 0 !important"
          [maxWords]="30"
          [autogenerate]="entityAowService.currentResultIsKnowledgeProduct()">
        </app-pr-input>

        <div class="separator"></div>

        <app-pr-textarea
          [isStatic]="true"
          placeholder="Provide input here..."
          [label]="
            entityAowService.currentResultIsKnowledgeProduct() ? 'Progress narrative of the High-Level Output' : 'Progress narrative of the Output'
          "
          type="text"
          [readOnly]="true"
          labelDescInlineStyles="margin-top: 0 !important"></app-pr-textarea>

        <div>
          <app-pr-field-header
            label="Contributing Science Programs/Accelerators"
            [required]="false"
            [labelDescInlineStyles]="'margin-top: 0 !important'">
          </app-pr-field-header>

          <p-multiselect
            [options]="[]"
            [optionLabel]="'full_name'"
            [optionValue]="'id'"
            placeholder="Select entity"
            [appendTo]="'body'"
            [style]="{ width: '100%', height: '32px' }"></p-multiselect>

          <app-pr-field-header
            label="Science Program(s) / Accelerator(s) selected"
            [required]="false"
            [labelDescInlineStyles]="'margin-top: 10px !important; font-weight: 300;'">
          </app-pr-field-header>

          <div class="selected_chips_container">
            <div class="selected_chip">
              <div class="name"><span class="font-weight-600">SP03 -</span> Sustainable Animal and Aquatic Foods</div>
              <i
                class="material-icons-round"
                style="font-size: 18px; cursor: pointer"
                (click)="removeOption({ full_name: 'SP03 - Sustainable Animal and Aquatic Foods' })">
                cancel
              </i>
            </div>
          </div>
        </div>

        <div>
          <app-pr-field-header
            label="Contributing to W3 and/or bilateral projects"
            [required]="false"
            [labelDescInlineStyles]="'margin-top: 0 !important'">
          </app-pr-field-header>

          <app-alert-status
            status="info"
            description="If you don't find the funder you are looking for, <a class='open_route pSelectP'>request</a> to have it added to the list."
            inlineStyles="margin: 0; margin-top: 10px;"></app-alert-status>

          <p-multiselect
            [options]="[]"
            [optionLabel]="'full_name'"
            [optionValue]="'id'"
            placeholder="Select an W3 and/or bilateral projects"
            [appendTo]="'body'"
            [style]="{ width: '100%', height: '32px', marginTop: '10px' }"></p-multiselect>

          <div class="selected_bilateral_container">
            <div class="selected_bilateral_item">
              <div class="selected_bilateral_item_content">
                <p class="pr-body-1 font-weight-300">
                  <span class="font-weight-500">1802 -</span> SPARC (International Livestock Research Institute )
                </p>
                <p class="pr-body-2 font-weight-300 italic">
                  <span class="font-weight-500 normal">Grant title:</span> RTB Investment: Towards building a portfolio of breeding investments in
                  banana, cassava, potato, sweetpotato and yam benefitting African smallholder farmers, rural and urban consumers
                </p>
              </div>
              <i
                class="material-icons-round"
                style="font-size: 20px; cursor: pointer; color: var(--pr-color-red-300)"
                (click)="removeOption({ full_name: 'W3 and/or bilateral projects' })">
                delete
              </i>
            </div>
          </div>
        </div>

        <div class="report-result-content_left_content_actions">
          <app-pr-button [verticalMargin]="0" text="Create and continue"></app-pr-button>
        </div>
      </div>
    </div>

    <div class="report-result-content_right">
      <h2 class="report-result-content_right_title">Existing results</h2>

      <div class="report-result-content_right_content">
        @for (item of [1, 2, 3, 4, 5]; track $index) {
          <div class="report-result-content_right_content_item">
            <i class="pi pi-book" style="font-size: 12px; color: var(--pr-color-neutral-200)"></i>
            <p class="pr-body-2"><span class="font-weight-600">100 -</span> Community-Based approaches to agricultural development</p>
          </div>
        }
      </div>
    </div>
  </div>
</p-dialog>
