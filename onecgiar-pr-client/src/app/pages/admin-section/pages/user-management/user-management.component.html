<div
  class="local_container section_container"
  [style]="{ width: this.dynamicPanelService.showCompletePanel() ? 'calc(100vw - 305px)' : 'calc(100vw - 118px)' }">
  <header>
    <i class="material-icons-round" style="font-size: 30px">manage_accounts</i>
    <h1>User Management</h1>
  </header>
  <div
    class="description"
    pTooltip="Welcome to the user management panel, here you can manage the users and their roles within the platform."
    tooltipPosition="bottom">
    Welcome to the user management panel, here you can manage the users and their roles within the platform.
  </div>

  <!-- Filter and action controls -->
  <div class="controls-section">
    <div class="controls-row">
      <!-- Filters group -->
      <div class="filters-group">
        <div class="filters-row">
          <!-- User search -->
          <div class="search-container">
            <label class="search-label" for="search-user-input">Search by user:</label>
            <div class="p-input-icon-left">
              <i class="pi pi-search"></i>
              <input
                type="text"
                pInputText
                placeholder="Search"
                [value]="searchText()"
                (input)="onSearchInputChange($event)"
                class="search-field"
                id="search-user-input" />
            </div>
          </div>

          <!-- Status filter -->

          <div class="status-filter">
            <label class="status-label" for="statusSelect">Status:</label>
            <app-pr-select
              #statusSelect
              id="statusSelect"
              [options]="statusOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="All"
              [ngModel]="selectedStatus()"
              (ngModelChange)="onStatusChange($event)"
              [required]="false"
              [indexReference]="1"></app-pr-select>
          </div>

          <!-- CGIAR filter -->
          <div class="cgiar-filter">
            <label class="cgiar-label" for="cgiarSelect">Is CGIAR:</label>
            <app-pr-select
              #cgiarSelect
              id="cgiarSelect"
              [options]="isCGIAROptions"
              optionLabel="label"
              optionValue="value"
              placeholder="All"
              [ngModel]="selectedCgiar()"
              (ngModelChange)="onCgiarChange($event)"
              [required]="false"
              [indexReference]="2"></app-pr-select>
          </div>

          <!-- Entity filter -->
          <div class="entity-filter">
            <label class="entity-label" for="entitiesSelect">Entity:</label>
            <app-pr-multi-select
              #entitiesSelect
              id="entitiesSelect"
              [options]="initiativesService.allInitiatives()"
              optionLabel="official_code"
              optionValue="id"
              placeholder="All"
              (selectOptionEvent)="getUsers()"
              [ngModel]="selectedEntities()"
              [required]="false"></app-pr-multi-select>
          </div>
        </div>

        <!-- Clear filters button -->
        <div class="clear-filter">
          <div class="clear-spacer">&nbsp;</div>
          <app-pr-button text="Clear filters" icon="filter_alt_off" colorType="secondary" (clickEvent)="onClearFilters()"></app-pr-button>
        </div>
      </div>

      <!-- Actions group -->
      <div class="actions-group">
        <app-pr-button text="Add a user" icon="add_circle" colorType="primary" (clickEvent)="onAddUser()"></app-pr-button>
      </div>
    </div>
  </div>

  <!-- Users table -->
  <div class="table-container">
    <p-table
      [value]="this.users()"
      [loading]="this.loading()"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-gridlines p-datatable-sm user-table"
      responsiveLayout="scroll"
      [style]="{
        'min-width': '200px',
        'max-width': this.dynamicPanelService.showCompletePanel() ? 'calc(100vw - 365px)' : 'calc(100vw - 178px)',
        transition: 'max-width 0.3s ease-in-out'
      }">
      <ng-template pTemplate="header">
        <tr>
          @for (column of columns; track column.key) {
            <th [style.width]="column.width" [pSortableColumn]="column.key" scope="col">
              <div class="header-content">
                {{ column.label }}
                <p-sortIcon [field]="column.key"></p-sortIcon>
              </div>
            </th>
          }
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-user let-i="rowIndex">
        <tr>
          <td>{{ user.firstName }} {{ user.lastName }}</td>
          <td>{{ user.emailAddress }}</td>
          <td>
            <div class="entities-container">
              @if (user.entities?.length > 0) {
                @let displayEntities = getDisplayEntities(user.entities);
                @for (entity of displayEntities; track entity) {
                  <div class="entity-chip">
                    <span>{{ entity }}</span>
                  </div>
                }
                @if (hasMoreEntities(user.entities)) {
                  <button class="view-more-btn" (click)="showEntityOverlay($event, entityOverlay, user.entities)" #entityTrigger type="button">
                    View more
                  </button>

                  <p-overlayPanel #entityOverlay [style]="{ width: '300px' }">
                    <div class="overlay-entities-container">
                      <div class="overlay-title">All Entities</div>
                      <div class="overlay-entities-grid">
                        @for (entity of user.entities; track entity) {
                          <div class="entity-chip">
                            <span>{{ entity }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  </p-overlayPanel>
                }
              } @else if (user.appRole) {
                <div class="app-role-chip">
                  <span>{{ user.appRole }}</span>
                </div>
              } @else {
                <span class="no-entities">No app role or entities.</span>
              }
            </div>
          </td>
          <td>{{ user.cgIAR }}</td>
          <td>{{ user.userCreationDate | date: 'yyyy-MM-dd' }}</td>
          <td>
            <span [class]="'status-' + user.userStatusClass" class="status-chip">
              {{ user.userStatus }}
            </span>
          </td>
          <td>
            <div class="action-buttons" [class.inactive-user]="!user.isActive">
              @if (user.isActive) {
                <button type="button" class="action-btn" (click)="onEditUser(user)" pTooltip="Edit user" tooltipPosition="top">
                  <i class="material-icons-round">edit</i>
                </button>
              }
              <button
                type="button"
                class="action-btn action-btn-toggle"
                (click)="onToggleUserStatus(user)"
                [pTooltip]="user.isActive ? 'Deactivate user' : 'Activate user'"
                tooltipPosition="top">
                <i class="material-icons-round">{{ user.isActive ? 'person_off' : 'person' }}</i>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="columns.length" class="no-data">No users match the entered criteria</td>
        </tr>
      </ng-template>
    </p-table>

    <!-- Floating counter like in global-completeness-status -->
    <div class="counter">
      <span class="name">Users |</span>
      <span class="total">{{ this.users().length }} total</span>
    </div>
  </div>

  <!-- Manage User Modal Component -->
  <app-manage-user-modal
    #manageUserModal
    [editingMode]="isEditingUser"
    [userActivatorMode]="isActivatingUser"
    [loadingUserRole]="loadingUserRole"
    [(visible)]="showAddUserModal"
    (managedUser)="this.getUsers()">
  </app-manage-user-modal>
</div>
