name: Security Scan (Snyk ‚Üí S3)

on:
  push:
    branches:
      - main
      - master
      - staging-security-scanning
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Install server dependencies
        working-directory: ./onecgiar-pr-server
        run: |
          # Install dependencies for server project
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Install client dependencies
        working-directory: ./onecgiar-pr-client
        run: |
          # Install dependencies for client project
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Run Snyk test - Server (JSON report)
        id: snyk-server-json
        working-directory: ./onecgiar-pr-server
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          # Scan server project: run Snyk test inside onecgiar-pr-server directory
          # This ensures we analyze the correct package.json and dependencies
          # Continue even if vulnerabilities are found (exit code 1)
          snyk test --json-file-output=../../snyk-server.json --file=package.json || true
          
          # Check if report was generated (path is relative to working-directory)
          if [ -f ../../snyk-server.json ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Snyk server JSON report generated"
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Snyk server JSON report not generated"
          fi

      - name: Run Snyk test - Server (SARIF report)
        id: snyk-server-sarif
        working-directory: ./onecgiar-pr-server
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          # Generate SARIF report for server project
          snyk test --sarif-file-output=../../snyk-server.sarif --file=package.json || true
          
          if [ -f ../../snyk-server.sarif ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Snyk server SARIF report generated"
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Snyk server SARIF report not generated"
          fi

      - name: Run Snyk test - Client (JSON report)
        id: snyk-client-json
        working-directory: ./onecgiar-pr-client
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          # Scan client project: run Snyk test inside onecgiar-pr-client directory
          # This ensures we analyze the correct package.json and dependencies
          # Continue even if vulnerabilities are found (exit code 1)
          snyk test --json-file-output=../../snyk-client.json --file=package.json || true
          
          # Check if report was generated (path is relative to working-directory)
          if [ -f ../../snyk-client.json ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Snyk client JSON report generated"
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Snyk client JSON report not generated"
          fi

      - name: Run Snyk test - Client (SARIF report)
        id: snyk-client-sarif
        working-directory: ./onecgiar-pr-client
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          # Generate SARIF report for client project
          snyk test --sarif-file-output=../../snyk-client.sarif --file=package.json || true
          
          if [ -f ../../snyk-client.sarif ]; then
            echo "sarif_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Snyk client SARIF report generated"
          else
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Snyk client SARIF report not generated"
          fi

      - name: Configure AWS credentials
        if: always() && !cancelled()
        env:
          AWS_SECURITY_ACCESS_KEY_ID: ${{ secrets.AWS_SECURITY_ACCESS_KEY_ID }}
          AWS_SECURITY_SECRET_ACCESS: ${{ secrets.AWS_SECURITY_SECRET_ACCESS }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          # Configure AWS CLI with IAM User credentials
          aws configure set aws_access_key_id "$AWS_SECURITY_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECURITY_SECRET_ACCESS"
          aws configure set region "$AWS_REGION"
          aws configure set output json
          echo "‚úÖ AWS credentials configured"

      - name: Upload reports to S3
        id: upload-s3
        if: always() && !cancelled()
        env:
          AWS_SECURITY_ACCESS_KEY_ID: ${{ secrets.AWS_SECURITY_ACCESS_KEY_ID }}
          AWS_SECURITY_SECRET_ACCESS: ${{ secrets.AWS_SECURITY_SECRET_ACCESS }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          S3_BUCKET: ${{ secrets.S3_BUCKET || 'ibd-snyk-security-reports' }}
          S3_PREFIX: ${{ secrets.S3_PREFIX || 'ibd-snyk-reports' }}
        run: |
          # Build S3 object path with repository, branch, timestamp, run ID, and project name
          REPO_NAME="${{ github.repository }}"
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          RUN_ID="${{ github.run_id }}"
          
          # Sanitize branch name (replace / with -)
          BRANCH_NAME_SANITIZED=$(echo "$BRANCH_NAME" | tr '/' '-')
          
          # Base S3 key structure: prefix/repo-name/branch/timestamp-runid/
          S3_BASE_PREFIX="${S3_PREFIX}/${REPO_NAME}/${BRANCH_NAME_SANITIZED}/${TIMESTAMP}-${RUN_ID}"
          
          echo "üì¶ Uploading reports to S3..."
          echo "Bucket: ${S3_BUCKET}"
          echo "Base prefix: ${S3_BASE_PREFIX}"
          
          UPLOADED_FILES=""
          
          # Upload server JSON report if it exists
          if [ -f snyk-server.json ]; then
            SERVER_JSON_KEY="${S3_BASE_PREFIX}/server/snyk-server.json"
            aws s3 cp snyk-server.json "s3://${S3_BUCKET}/${SERVER_JSON_KEY}" --content-type "application/json"
            echo "‚úÖ Uploaded server JSON: ${SERVER_JSON_KEY}"
            echo "server_json_key=${SERVER_JSON_KEY}" >> $GITHUB_OUTPUT
            UPLOADED_FILES="${UPLOADED_FILES}Server JSON, "
          fi
          
          # Upload server SARIF report if it exists
          if [ -f snyk-server.sarif ]; then
            SERVER_SARIF_KEY="${S3_BASE_PREFIX}/server/snyk-server.sarif"
            aws s3 cp snyk-server.sarif "s3://${S3_BUCKET}/${SERVER_SARIF_KEY}" --content-type "application/json"
            echo "‚úÖ Uploaded server SARIF: ${SERVER_SARIF_KEY}"
            echo "server_sarif_key=${SERVER_SARIF_KEY}" >> $GITHUB_OUTPUT
            UPLOADED_FILES="${UPLOADED_FILES}Server SARIF, "
          fi
          
          # Upload client JSON report if it exists
          if [ -f snyk-client.json ]; then
            CLIENT_JSON_KEY="${S3_BASE_PREFIX}/client/snyk-client.json"
            aws s3 cp snyk-client.json "s3://${S3_BUCKET}/${CLIENT_JSON_KEY}" --content-type "application/json"
            echo "‚úÖ Uploaded client JSON: ${CLIENT_JSON_KEY}"
            echo "client_json_key=${CLIENT_JSON_KEY}" >> $GITHUB_OUTPUT
            UPLOADED_FILES="${UPLOADED_FILES}Client JSON, "
          fi
          
          # Upload client SARIF report if it exists
          if [ -f snyk-client.sarif ]; then
            CLIENT_SARIF_KEY="${S3_BASE_PREFIX}/client/snyk-client.sarif"
            aws s3 cp snyk-client.sarif "s3://${S3_BUCKET}/${CLIENT_SARIF_KEY}" --content-type "application/json"
            echo "‚úÖ Uploaded client SARIF: ${CLIENT_SARIF_KEY}"
            echo "client_sarif_key=${CLIENT_SARIF_KEY}" >> $GITHUB_OUTPUT
            UPLOADED_FILES="${UPLOADED_FILES}Client SARIF, "
          fi
          
          # Save metadata for Slack notification
          echo "s3_bucket=${S3_BUCKET}" >> $GITHUB_OUTPUT
          echo "s3_base_prefix=${S3_BASE_PREFIX}" >> $GITHUB_OUTPUT
          echo "repo_name=${REPO_NAME}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "uploaded_files=${UPLOADED_FILES}" >> $GITHUB_OUTPUT

      - name: Generate pre-signed S3 URLs
        id: presign-urls
        if: always() && !cancelled() && (steps.upload-s3.outputs.server_json_key != '' || steps.upload-s3.outputs.client_json_key != '')
        env:
          AWS_SECURITY_ACCESS_KEY_ID: ${{ secrets.AWS_SECURITY_ACCESS_KEY_ID }}
          AWS_SECURITY_SECRET_ACCESS: ${{ secrets.AWS_SECURITY_SECRET_ACCESS }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          # Generate pre-signed URLs valid for 7 days (604800 seconds)
          EXPIRY_SECONDS=604800
          S3_BUCKET="${{ steps.upload-s3.outputs.s3_bucket }}"
          
          # Pre-signed URL for server JSON report
          if [ -n "${{ steps.upload-s3.outputs.server_json_key }}" ]; then
            SERVER_JSON_URL=$(aws s3 presign "s3://${S3_BUCKET}/${{ steps.upload-s3.outputs.server_json_key }}" --expires-in ${EXPIRY_SECONDS})
            echo "server_json_url=${SERVER_JSON_URL}" >> $GITHUB_OUTPUT
            echo "‚úÖ Generated pre-signed URL for server JSON report (expires in 7 days)"
          fi
          
          # Pre-signed URL for server SARIF report
          if [ -n "${{ steps.upload-s3.outputs.server_sarif_key }}" ]; then
            SERVER_SARIF_URL=$(aws s3 presign "s3://${S3_BUCKET}/${{ steps.upload-s3.outputs.server_sarif_key }}" --expires-in ${EXPIRY_SECONDS})
            echo "server_sarif_url=${SERVER_SARIF_URL}" >> $GITHUB_OUTPUT
            echo "‚úÖ Generated pre-signed URL for server SARIF report (expires in 7 days)"
          fi
          
          # Pre-signed URL for client JSON report
          if [ -n "${{ steps.upload-s3.outputs.client_json_key }}" ]; then
            CLIENT_JSON_URL=$(aws s3 presign "s3://${S3_BUCKET}/${{ steps.upload-s3.outputs.client_json_key }}" --expires-in ${EXPIRY_SECONDS})
            echo "client_json_url=${CLIENT_JSON_URL}" >> $GITHUB_OUTPUT
            echo "‚úÖ Generated pre-signed URL for client JSON report (expires in 7 days)"
          fi
          
          # Pre-signed URL for client SARIF report
          if [ -n "${{ steps.upload-s3.outputs.client_sarif_key }}" ]; then
            CLIENT_SARIF_URL=$(aws s3 presign "s3://${S3_BUCKET}/${{ steps.upload-s3.outputs.client_sarif_key }}" --expires-in ${EXPIRY_SECONDS})
            echo "client_sarif_url=${CLIENT_SARIF_URL}" >> $GITHUB_OUTPUT
            echo "‚úÖ Generated pre-signed URL for client SARIF report (expires in 7 days)"
          fi

      - name: Send Slack notification
        if: always() && !cancelled() && steps.upload-s3.outputs.repo_name != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SERVER_JSON_URL: ${{ steps.presign-urls.outputs.server_json_url }}
          CLIENT_JSON_URL: ${{ steps.presign-urls.outputs.client_json_url }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è Slack webhook not configured, skipping notification."
            exit 0
          fi
          
          REPO_NAME="${{ steps.upload-s3.outputs.repo_name }}"
          BRANCH_NAME="${{ steps.upload-s3.outputs.branch_name }}"
          GITHUB_RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          GITHUB_RUN_NUMBER="${{ github.run_number }}"
          UPLOADED_FILES="${{ steps.upload-s3.outputs.uploaded_files }}"
          
          # Clean up trailing comma and space from uploaded files
          UPLOADED_FILES_CLEAN=$(echo "$UPLOADED_FILES" | sed 's/, $//')
          
          # Build download links for server and client reports
          SERVER_LINK=""
          CLIENT_LINK=""
          
          if [ -n "$SERVER_JSON_URL" ]; then
            SERVER_LINK="<${SERVER_JSON_URL}|Server Report>"
          fi
          
          if [ -n "$CLIENT_JSON_URL" ]; then
            CLIENT_LINK="<${CLIENT_JSON_URL}|Client Report>"
          fi
          
          # Determine scan status
          if [ "${{ steps.snyk-server-json.outputs.report_exists }}" = "true" ] || [ "${{ steps.snyk-client-json.outputs.report_exists }}" = "true" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="completed"
          else
            STATUS_EMOJI="‚ö†Ô∏è"
            STATUS_TEXT="completed with warnings"
          fi
          
          # Build Slack message payload
          PAYLOAD=$(cat <<EOF
          {
            "text": "${STATUS_EMOJI} Security scan ${STATUS_TEXT} ‚Äî ${REPO_NAME}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${STATUS_EMOJI} Snyk Security Scan ${STATUS_TEXT}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n\`${REPO_NAME}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n\`${BRANCH_NAME}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Reports Generated:*\n${UPLOADED_FILES_CLEAN}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*GitHub Run:*\n<${GITHUB_RUN_URL}|View Run #${GITHUB_RUN_NUMBER}>"
                  }
                ]
              }
          EOF
          )
          
          # Add download links section if reports were uploaded
          if [ -n "$SERVER_LINK" ] || [ -n "$CLIENT_LINK" ]; then
            DOWNLOAD_TEXT="*üì• Download Reports (valid for 7 days):*"
            if [ -n "$SERVER_LINK" ]; then
              DOWNLOAD_TEXT="${DOWNLOAD_TEXT}\n‚Ä¢ Server: ${SERVER_LINK}"
            fi
            if [ -n "$CLIENT_LINK" ]; then
              DOWNLOAD_TEXT="${DOWNLOAD_TEXT}\n‚Ä¢ Client: ${CLIENT_LINK}"
            fi
            
            DOWNLOAD_SECTION=$(cat <<EOF
              ,
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${DOWNLOAD_TEXT}"
                }
              }
          EOF
          )
          PAYLOAD="${PAYLOAD}${DOWNLOAD_SECTION}"
          fi
          
          # Close blocks array
          PAYLOAD="${PAYLOAD}]}"
          
          # Send to Slack
          curl -s -X POST \
            -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" || echo "‚ö†Ô∏è Failed to send Slack notification"
          
          echo "‚úÖ Slack notification sent"
