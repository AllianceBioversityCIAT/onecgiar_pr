name: Security Scan (Snyk)

on:
  pull_request:
  push:
    branches:
      - main
      - master
  schedule:
    # Weekly on Monday at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  snyk-scan:
    name: Snyk dependency scan
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Run Snyk dependency scan (SARIF)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test --sarif-file-output=snyk.sarif --file=package.json || true

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && !cancelled() && hashFiles('snyk.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk.sarif
        continue-on-error: true

      - name: Notify Slack
        if: always() && !cancelled() && github.event_name != 'workflow_dispatch'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured, skipping notification."
            exit 0
          fi
          BRANCH="${{ github.head_ref || github.ref_name }}"
          REPO="${{ github.repository }}"
          LINK="https://github.com/${REPO}/security/code-scanning"
          PAYLOAD=$(cat <<EOF
          {
            "text": "Security scan completed â€” *${REPO}* (branch: \`${BRANCH}\`)",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Security scan (Snyk)*\nRepository: *${REPO}*\nBranch: \`${BRANCH}\`\n<${LINK}|View Code Scanning results>"
                }
              }
            ]
          }
          EOF
          )
          curl -s -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" || true
